#!/bin/bash

set -e

# Set repo path
cd ~/mmx

echo "ğŸ” Applying manifest resume patch..."
python3 patch_manifest_resume.py --dir ~/mmx

echo "ğŸ” Applying progress JSON-lines patch..."
python3 patch_progress.py --dir ~/mmx

echo "ğŸ” Verifying --execute CLI plumbing..."
cargo build -F mmx-core/gst --release

# Link compat binary as ffmpeg + ffprobe
sudo ln -sf ~/mmx/target/release/mmx-compat /usr/local/bin/ffmpeg
sudo ln -sf ~/mmx/target/release/mmx-compat /usr/local/bin/ffprobe

echo "ğŸ” Initializing git (if needed)..."
git init
git remote add origin git@github.com:youruser/mmx.git 2>/dev/null || true

echo "ğŸ” Creating initial commit and changelog..."
git add .
git commit -m "ğŸš€ Initial commit with resume/progress patches + compat link"
echo -e "# Changelog\n\n## [0.2.2] - $(date '+%Y-%m-%d')\n- Applied manifest resume patch\n- Applied progress JSON-lines patch\n- Linked ffmpeg/ffprobe compat\n" > CHANGELOG.md
git add CHANGELOG.md

echo "ğŸ” Tagging version..."
cargo set-version 0.2.2
git commit -am "ğŸ”– Bump version to 0.2.2"
git tag v0.2.2

echo "ğŸ” Final check â€” does MMX CLI build clean?"
cargo build -F mmx-core/gst --release

echo "âœ… MMX is now fully patched, versioned, and CLI-ready."
echo "ğŸ“ Check: git tag -l | grep v0.2.2"
